<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Data Conflicts Detected</title>
    <style>
      body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
      .header { background-color: #f8f9fa; padding: 20px; border-left: 4px solid #dc3545; margin-bottom: 20px; }
      .summary { background-color: #fff3cd; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
      .conflict { background-color: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 4px; border-left: 3px solid #ffc107; }
      .conflict-type { font-weight: bold; color: #856404; text-transform: uppercase; font-size: 12px; }
      .address { font-weight: bold; color: #495057; }
      .details { margin: 10px 0; }
      .change { margin: 5px 0; }
      .old-value { color: #dc3545; text-decoration: line-through; }
      .new-value { color: #28a745; font-weight: bold; }
      .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; font-size: 12px; color: #6c757d; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üö® Data Conflicts Detected</h1>
      <p><strong>Timestamp:</strong> <%= @timestamp.strftime("%B %d, %Y at %I:%M %p %Z") %></p>
      <p><strong>Job Duration:</strong> <%= "%.2f" % @job_duration %> seconds</p>
    </div>

    <div class="summary">
      <h2>üìä Summary</h2>
      <ul>
        <li><strong>Total Conflicts:</strong> <%= @summary[:total_conflicts] %></li>
        <li><strong>Resolved Automatically:</strong> <%= @summary[:resolved_automatically] %></li>
        <li><strong>Requires Manual Review:</strong> <%= @summary[:requires_manual_review] %></li>
      </ul>
      
      <% if @summary[:conflicts_by_type] %>
        <h3>Conflicts by Type:</h3>
        <ul>
          <% @summary[:conflicts_by_type].each do |type, count| %>
            <li><strong><%= type.humanize %>:</strong> <%= count %></li>
          <% end %>
        </ul>
      <% end %>
    </div>

    <h2>üîç Conflict Details</h2>
    
    <% @conflicts.each_with_index do |conflict, index| %>
      <div class="conflict">
        <div class="conflict-type"><%= conflict[:type].humanize %></div>
        <div class="address">üìç <%= conflict[:address] || "House ID: #{conflict[:house_id]}" %></div>
        <div class="details">
          <strong>PCPA UID:</strong> <%= conflict[:pcpa_uid] %>
          <br>
          <strong>Resolution:</strong> <%= conflict[:resolution].humanize %>
          <br>
          <strong>Timestamp:</strong> <%= conflict[:timestamp].strftime("%I:%M:%S %p") %>
        </div>

        <% case conflict[:type] %>
        <% when 'address_change' %>
          <div class="change">
            <strong>Address Change:</strong><br>
            <span class="old-value">Old: <%= conflict[:old_address] %></span><br>
            <span class="new-value">New: <%= conflict[:new_address] %></span>
          </div>
        <% when 'coordinate_change' %>
          <div class="change">
            <strong>Coordinate Change:</strong><br>
            <span class="old-value">Old: <%= conflict[:old_coordinates][:lat] %>, <%= conflict[:old_coordinates][:lng] %></span><br>
            <span class="new-value">New: <%= conflict[:new_coordinates][:lat] %>, <%= conflict[:new_coordinates][:lng] %></span><br>
            <strong>Distance Moved:</strong> <%= "%.1f" % conflict[:distance_moved] %> meters
          </div>
        <% when 'ownership_change' %>
          <div class="change">
            <strong>Ownership Change:</strong><br>
            <span class="old-value">Old: <%= conflict[:old_owners].join(", ") %></span><br>
            <span class="new-value">New: <%= conflict[:new_owners].join(", ") %></span>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="footer">
      <p>This email was automatically generated by the Property Data Import Job.<br>
      For questions or concerns, please contact the development team.</p>
    </div>
  </body>
</html>